<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Magic Learning Pro (V37 - Huawei Safe Mode)</title>
    <style>
        /* === å…¨å±€æ ·å¼ === */
        :root { --primary: #2979FF; --bg-grey: #F5F7FA; --text-main: #333; --green: #4CAF50; }
        body { margin: 0; font-family: "Comic Sans MS", -apple-system, sans-serif; background: var(--bg-grey); height: 100vh; overflow: hidden; display: flex; flex-direction: column; color: var(--text-main); }
        
        /* === é¡¶éƒ¨å¯¼èˆªæ  === */
        header { 
            height: 50px; background: white; border-bottom: 1px solid #E0E0E0; 
            display: flex; align-items: center; padding: 0 10px; gap: 8px;
            flex-shrink: 0; overflow-x: auto; 
        }
        .back-btn { border: 1px solid #ddd; background: white; padding: 4px 10px; border-radius: 20px; cursor: pointer; color: #555; font-size: 12px; white-space: nowrap; }
        
        .nav-group { display: flex; align-items: center; gap: 4px; border-right: 1px solid #eee; padding-right: 8px; margin-right: 4px; }
        /* åä¸ºä¿®å¤ï¼šéšè—è¯­é€ŸæŒ‰é’®ï¼Œé˜²æ­¢å¼•æ“å´©æºƒ */
        .speed-btn { 
            border: 1px solid #ddd; background: #f9f9f9; padding: 4px 6px; border-radius: 4px; 
            cursor: pointer; font-size: 12px; min-width: 30px;
        }
        .speed-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        #play-all-btn {
            background: var(--green); color: white; border: 1px solid var(--green); 
            font-weight: bold; padding: 4px 10px; font-size: 12px; display: flex; align-items: center; gap: 4px; white-space: nowrap;
        }
        #play-all-btn.playing { background: #E53935; border-color: #E53935; }

        /* === ä¸»å¸ƒå±€ === */
        #main-container { display: flex; flex: 1; overflow: hidden; flex-direction: column; position: relative; }

        /* å·¦æ ï¼šå›¾ç‰‡ */
        #col-left { 
            flex: 0 0 30%; background: #ffffff; 
            display: flex; align-items: center; justify-content: center;
            padding: 10px; box-sizing: border-box; border-bottom: 1px solid #eee;
        }
        #scene-img { 
            width: 100%; height: 100%; object-fit: contain; 
            border-radius: 8px; filter: drop-shadow(0 2px 5px rgba(0,0,0,0.1));
        }

        /* ä¸­æ ï¼šè„šæœ¬ */
        #col-mid { 
            flex: 1; background: var(--bg-grey); 
            overflow-y: auto; padding: 15px; 
        }

        /* å³æ ï¼šå•è¯è¡¨ */
        #col-right { 
            display: flex; flex-direction: column;
            flex: 0 0 30%; background: white; 
            border-top: 2px solid #FFD54F; z-index: 10;
        }

        /* PCç«¯å“åº”å¼ */
        @media (min-width: 768px) {
            header { height: 60px; padding: 0 20px; }
            #main-container { flex-direction: row; }
            #col-left { flex: 0 0 400px; height: 100%; border-right: 1px solid #ddd; border-bottom: none; }
            #col-mid { flex: 1; border-right: 1px solid #ddd; }
            #col-right { flex: 0 0 300px; height: 100%; border-top: none; }
        }

        /* === å†…å®¹å¡ç‰‡æ ·å¼ === */
        .script-card {
            background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 2px solid transparent; cursor: pointer; transition: 0.2s;
        }
        .script-card.active { border-color: var(--primary); background: #E3F2FD; }
        .en-text { font-size: 18px; font-weight: 500; line-height: 1.5; margin-bottom: 8px; color: #222; }
        .cn-text { font-size: 14px; color: #666; margin-bottom: 5px; }
        .highlight-word { color: #00897B; border-bottom: 2px solid #4DB6AC; font-weight: bold; cursor: pointer; }

        /* === å•è¯å¡ç‰‡æ ·å¼ === */
        .vocab-header { 
            padding: 10px; background: #FAFAFA; font-weight: bold; font-size: 14px; color: #333; 
            border-bottom: 1px solid #eee; text-align: center; 
            cursor: pointer; user-select: none; transition: background 0.2s;
        }
        .vocab-header:hover { background: #E3F2FD; color: var(--primary); }
        .vocab-header:active { background: #BBDEFB; }

        .vocab-list { flex: 1; overflow-y: auto; padding: 10px; scroll-behavior: smooth; }
        .vocab-card { 
            border: 1px solid #eee; border-radius: 8px; padding: 10px; margin-bottom: 8px; 
            background: #fff; border-left: 4px solid #ddd; cursor: pointer;
        }
        .vocab-card.focused { border-left-color: #FF9800 !important; background-color: #FFF3E0 !important; }
        .vocab-top { display: flex; justify-content: space-between; align-items: center; }
        .vocab-word { font-size: 18px; font-weight: bold; color: #333; }
        
        .vocab-mask { margin-top: 5px; font-size: 12px; color: #999; background: #f5f5f5; padding: 4px; text-align: center; }
        .vocab-reveal { display: none; margin-top: 5px; padding-top: 5px; border-top: 1px solid #f0f0f0; font-size: 14px; }
        
        .vocab-card.revealed .vocab-mask { display: none; }
        .vocab-card.revealed .vocab-reveal { display: block; }

        /* === äº’åŠ¨æµ‹éªŒåŒºæ ·å¼ === */
        .section-divider { text-align: center; margin: 30px 0 20px 0; color: #888; font-size: 14px; }
        .quiz-card { background: #FFF3E0; border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 2px dashed #FFB74D; }
        
        .quiz-opt { 
            background: white; border: 1px solid #FFCC80; padding: 10px; border-radius: 8px; 
            margin-bottom: 8px; cursor: pointer; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .quiz-opt.correct { background: #C8E6C9; border-color: #4CAF50; }
        .quiz-opt.wrong { background: #FFCDD2; border-color: #F44336; }
        .quiz-opt::after { content: ''; font-weight: bold; font-size: 18px; margin-left: 10px; }
        .quiz-opt.correct::after { content: 'âœ…'; color: #2E7D32; }
        .quiz-opt.wrong::after { content: 'âŒ'; color: #C62828; }

        .audio-btn {
            border: 1px solid var(--primary); background-color: white; color: var(--primary);
            border-radius: 6px; padding: 4px 10px; margin-left: 10px; cursor: pointer;
            font-size: 14px; display: flex; align-items: center; gap: 4px; transition: 0.2s;
        }
        .audio-btn:active { background-color: #E3F2FD; transform: scale(0.95); }

        /* === ä»ªå¼æ„Ÿ Start é®ç½©å±‚ === */
        #start-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255, 0.95);
            backdrop-filter: blur(5px);
            z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .big-start-btn {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white; border: none; padding: 15px 40px; border-radius: 50px;
            font-size: 24px; font-weight: bold; box-shadow: 0 5px 20px rgba(76, 175, 80, 0.4);
            cursor: pointer; transition: transform 0.2s; font-family: "Comic Sans MS", cursive;
            display: flex; align-items: center; gap: 10px;
        }
        .big-start-btn:active { transform: scale(0.95); }
        .big-start-btn:hover { transform: scale(1.05); }

        /* === è´¦å·å¯†ç ç™»å½•æ¡† === */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #2979FF; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white;
        }
        .login-box {
            background: white; padding: 30px; border-radius: 20px; width: 85%; max-width: 320px;
            text-align: center; color: #333; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .login-input {
            width: 100%; padding: 12px; margin: 8px 0; border: 2px solid #eee; border-radius: 8px;
            font-size: 16px; box-sizing: border-box; background: #f9f9f9; outline: none;
        }
        .login-input:focus { border-color: #2979FF; background: white; }
        
        .login-btn {
            width: 100%; padding: 12px; background: #2979FF; color: white; border: none;
            border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 15px;
        }
        .login-btn:active { background: #1565C0; }

        /* === è°ƒè¯•å·¥å…· === */
        #debug-console {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 80px;
            background: rgba(0,0,0,0.8); color: #00FF00; font-family: monospace;
            font-size: 10px; padding: 5px; box-sizing: border-box;
            overflow-y: auto; z-index: 20000; pointer-events: none;
        }

    </style>
</head>
<body>

    <div id="debug-console">Wait for logs...</div>

    <div id="login-overlay">
        <div class="login-box">
            <h2 style="margin-top:0; color:#2979FF;">ğŸ” å­¦å‘˜ç™»å½•</h2>
            <div style="text-align:left; font-size:14px; color:#666; margin-bottom:5px;">è´¦å· (Username)</div>
            <input type="text" id="username-input" class="login-input" placeholder="è¯·è¾“å…¥è´¦å·">
            <div style="text-align:left; font-size:14px; color:#666; margin-bottom:5px;">å¯†ç  (Password)</div>
            <input type="password" id="password-input" class="login-input" placeholder="è¯·è¾“å…¥å¯†ç ">
            <button class="login-btn" onclick="checkAccountLogin()">ç™»å½• / Login</button>
            <p id="login-msg" style="color:red; font-size:13px; margin-top:10px; min-height:20px;"></p>
        </div>
        <p style="margin-top:20px; font-size:12px; opacity:0.7;">Magic Learning Pro V37</p>
    </div>

    <div id="menu-screen" style="padding:40px; text-align:center;">
        <h2>ğŸ“š é­”æ³•ç²¾è¯» (V37)</h2>
        <div onclick="openBook()" style="background:white; display:inline-block; padding:20px; border-radius:15px; cursor:pointer; box-shadow:0 4px 15px rgba(0,0,0,0.1); max-width: 320px;">
            <img id="cover-img" src="images/story001_yellowbus/p1.jpg" alt="Story Cover" style="background-color:#eee; border-radius:10px; margin-bottom:10px; width: 100%; height: auto; min-height: 200px; object-fit: cover; aspect-ratio: 4/3;">
            <h3>The Yellow Bus</h3>
            <p style="color:#666; font-size:12px;">ç‚¹å‡»å°é¢è¿›å…¥</p>
        </div>
    </div>

    <div id="learning-screen" style="display:none; height:100vh; flex-direction:column;">
        <div id="start-overlay">
            <div style="font-size:60px; margin-bottom:20px;">ğŸšŒ</div>
            <button class="big-start-btn" onclick="startStory()">
                âœ¨ Start Story âœ¨
            </button>
        </div>

        <header>
            <div class="nav-group" style="border:none;">
                <button class="back-btn" onclick="location.reload()">â¬… ä¹¦æ¶</button>
            </div>
            <div class="nav-group" style="border:none;">
                <button class="speed-btn" onclick="setSpeed(0.5)">0.5</button>
                <button class="speed-btn" onclick="setSpeed(0.75)">0.75</button>
                <button class="speed-btn active" onclick="setSpeed(1.0)">1.0</button>
            </div>
            <button id="play-all-btn" class="speed-btn" onclick="toggleAutoPlay()">â–¶ å…¨æ–‡</button>
        </header>

        <div id="main-container">
            <div id="col-left">
                <img id="scene-img" src="" style="background-color:#eee;" onerror="this.alt='å›¾ç‰‡æœªæ‰¾åˆ°'">
            </div>
            <div id="col-mid"></div>
            <div id="col-right">
                <div id="vocab-header-el" class="vocab-header" onclick="revealAllVocab()" title="ç‚¹å‡»å±•å¼€æ‰€æœ‰å•è¯">ğŸ”‘ æ ¸å¿ƒè¯æ±‡ (ç‚¹å‡»å…¨æ˜¾)</div>
                <div class="vocab-list" id="vocab-container"></div>
            </div>
        </div>
    </div>

<script>
    function log(msg) {
        const box = document.getElementById('debug-console');
        const time = new Date().toLocaleTimeString();
        box.innerHTML = `[${time}] ${msg}<br>` + box.innerHTML;
        console.log(`[MagicLog] ${msg}`);
    }

    /* ================= ç™»å½•ç³»ç»Ÿ ================= */
    const USER_DATABASE = { "vip1": "123456", "vip2": "123456", "student": "888888", "class01": "000000" };

    function checkAccountLogin() {
        const userIn = document.getElementById('username-input').value.trim();
        const passIn = document.getElementById('password-input').value.trim();
        const msg = document.getElementById('login-msg');

        if (USER_DATABASE[userIn] && USER_DATABASE[userIn] === passIn) {
            msg.innerText = "âœ… ç™»å½•æˆåŠŸï¼";
            msg.style.color = "green";
            localStorage.setItem('magic_user_account', userIn);
            wakeUpAudio();
            setTimeout(() => { document.getElementById('login-overlay').style.display = 'none'; }, 500);
        } else {
            msg.innerText = "âŒ è´¦å·æˆ–å¯†ç é”™è¯¯";
            msg.style.color = "red";
        }
    }

    window.addEventListener('load', () => {
        log("App Loaded.");
        if (!('speechSynthesis' in window)) {
            alert("æ‚¨çš„è®¾å¤‡ä¸æ”¯æŒè¯­éŸ³åˆæˆï¼Œè¯·æ£€æŸ¥è®¾ç½®ã€‚");
        }
        const savedUser = localStorage.getItem('magic_user_account');
        if (savedUser && USER_DATABASE[savedUser]) {
            document.getElementById('login-overlay').style.display = 'none';
        }
        setRandomCoverImage();
        // åä¸ºä¿®å¤ï¼šä¸åœ¨è¿™é‡Œå¼ºåˆ¶ initVoicesï¼Œå› ä¸ºå¯èƒ½å¯¼è‡´å¡æ­»
    });

    /* ================= æ•°æ®æº ================= */
    const storyData = {
        title: "The Yellow Bus",
        paragraphs: [
            { text: "I go to {school} by the {yellow} {bus} every {morning}. It is a {big} and {long} car.", cn: "æˆ‘æ¯å¤©æ—©ä¸Šåé»„è‰²æ ¡è½¦å»ä¸Šå­¦ã€‚å®ƒæ˜¯ä¸€è¾†åˆå¤§åˆé•¿çš„è½¦ã€‚", img: "images/story001_yellowbus/p1.jpg", vocab: { "school": { ph: "/skuËl/", pos: "n.", cn: "å­¦æ ¡" }, "yellow": { ph: "/Ëˆjel.oÊŠ/", pos: "adj.", cn: "é»„è‰²çš„" }, "bus": { ph: "/bÊŒs/", pos: "n.", cn: "å…¬å…±æ±½è½¦" }, "morning": { ph: "/ËˆmÉ”Ër.nÉªÅ‹/", pos: "n.", cn: "æ—©æ™¨" }, "big": { ph: "/bÉªÉ¡/", pos: "adj.", cn: "å¤§çš„" }, "long": { ph: "/lÉ‘ËÅ‹/", pos: "adj.", cn: "é•¿çš„" } } },
            { text: "The {driver} is Mr. Brown. He is very {nice} to us.", cn: "å¸æœºæ˜¯å¸ƒæœ—å…ˆç”Ÿï¼Œä»–å¯¹æˆ‘ä»¬å¾ˆå‹å–„ã€‚", img: "images/story001_yellowbus/p2.jpg", vocab: { "driver": { ph: "/ËˆdraÉª.vÉš/", pos: "n.", cn: "å¸æœº" }, "nice": { ph: "/naÉªs/", pos: "adj.", cn: "å‹å¥½çš„" } } },
            { text: "I {wait} for the bus at the bus {stop}. When the {door} {opens}, I see my {friends} {inside}.", cn: "æˆ‘åœ¨è½¦ç«™ç­‰è½¦ã€‚å½“è½¦é—¨æ‰“å¼€æ—¶ï¼Œæˆ‘çœ‹åˆ°æˆ‘çš„æœ‹å‹ä»¬åœ¨é‡Œé¢ã€‚", img: "images/story001_yellowbus/p3.jpg", vocab: { "wait": { ph: "/weÉªt/", pos: "v.", cn: "ç­‰å¾…" }, "stop": { ph: "/stÉ‘Ëp/", pos: "n.", cn: "è½¦ç«™" }, "door": { ph: "/dÉ”Ër/", pos: "n.", cn: "é—¨" }, "opens": { ph: "/ËˆoÊŠ.pÉ™nz/", pos: "v.", cn: "æ‰“å¼€" }, "friends": { ph: "/frendz/", pos: "n.", cn: "æœ‹å‹" }, "inside": { ph: "/ÉªnËˆsaÉªd/", pos: "adv.", cn: "åœ¨é‡Œé¢" } } },
            { text: "We {sit} together and {look} out the {window}. We {talk} and {laugh} {happily}.", cn: "æˆ‘ä»¬ååœ¨ä¸€èµ·çœ‹çª—å¤–ã€‚æˆ‘ä»¬å¼€å¿ƒåœ°è¯´è¯å¤§ç¬‘ã€‚", img: "images/story001_yellowbus/p4.jpg", vocab: { "sit": { ph: "/sÉªt/", pos: "v.", cn: "å" }, "look": { ph: "/lÊŠk/", pos: "v.", cn: "çœ‹" }, "window": { ph: "/ËˆwÉªn.doÊŠ/", pos: "n.", cn: "çª—æˆ·" }, "talk": { ph: "/tÉ‘Ëk/", pos: "v.", cn: "è¯´è¯" }, "laugh": { ph: "/lÃ¦f/", pos: "v.", cn: "ç¬‘" }, "happily": { ph: "/ËˆhÃ¦p.É™l.i/", pos: "adv.", cn: "å¿«ä¹åœ°" } } },
            { text: "The bus {ride} is {safe} and {fun}. I {love} the yellow bus.", cn: "åæ ¡è½¦æ—¢å®‰å…¨åˆæœ‰è¶£ã€‚æˆ‘çˆ±é»„è‰²æ ¡è½¦ã€‚", img: "images/story001_yellowbus/p5.jpg", vocab: { "ride": { ph: "/raÉªd/", pos: "n.", cn: "æ—…ç¨‹/ä¹˜è½¦" }, "safe": { ph: "/seÉªf/", pos: "adj.", cn: "å®‰å…¨çš„" }, "fun": { ph: "/fÊŒn/", pos: "adj.", cn: "æœ‰è¶£çš„" }, "love": { ph: "/lÊŒv/", pos: "v.", cn: "çˆ±" } } }
        ],
        quizzes: [
            { question: "What color is the bus?", options: ["Red", "Yellow", "Blue"], answer: 1 },
            { question: "Who is the driver?", options: ["Mr. Green", "Mr. Brown", "Mr. Black"], answer: 1 },
            { question: "Are they happy on the bus?", options: ["Yes", "No"], answer: 0 }
        ]
    };

    let currentRate = 1.0;
    let isAutoPlaying = false; 
    let currentUtterance = null;
    let availableVoices = [];

    function setRandomCoverImage() {
        const coverImg = document.getElementById('cover-img');
        if (!coverImg || !storyData.paragraphs.length) return;
        const storyImages = storyData.paragraphs.map(p => p.img);
        const randomIndex = Math.floor(Math.random() * storyImages.length);
        if(storyImages[randomIndex]) coverImg.src = storyImages[randomIndex];
    }

    function wakeUpAudio() {
        window.speechSynthesis.cancel();
        let silent = new SpeechSynthesisUtterance("");
        silent.volume = 0;
        window.speechSynthesis.speak(silent);
    }

    function openBook() {
        document.getElementById('menu-screen').style.display = 'none';
        document.getElementById('learning-screen').style.display = 'flex';
        document.getElementById('start-overlay').style.display = 'flex';
        wakeUpAudio();
        renderContent();
        activateParagraph(0, true); 
    }

    function startStory() {
        log("Start button clicked.");
        document.getElementById('start-overlay').style.display = 'none';
        window.speechSynthesis.cancel();
        
        // åä¸ºä¿®å¤ï¼šç‚¹å‡»æ—¶æ‰å»è·å–è¯­éŸ³åˆ—è¡¨ï¼Œè€Œä¸æ˜¯é¡µé¢åŠ è½½æ—¶
        availableVoices = window.speechSynthesis.getVoices();
        log("Voices found: " + availableVoices.length);
        
        startAutoPlay();
    }

    window.revealAllVocab = function() {
        const container = document.getElementById('vocab-container');
        const header = document.getElementById('vocab-header-el');
        if(header) { header.innerText = "ğŸ”“ å…¨ä¹¦è¯æ±‡ (å·²å…¨éƒ¨åŠ è½½)"; header.style.color = "#4CAF50"; }
        container.innerHTML = "";
        storyData.paragraphs.forEach(para => {
            for (let [word, info] of Object.entries(para.vocab)) {
                let card = createVocabCard(word, info);
                card.classList.add('revealed');
                container.appendChild(card);
            }
        });
    }

    function createVocabCard(word, info) {
        let card = document.createElement('div');
        card.className = 'vocab-card';
        card.id = `vocab-card-${word}`;
        card.onclick = function() {
            stopAutoPlay();
            document.querySelectorAll('.vocab-card').forEach(el => el.classList.remove('focused'));
            this.classList.add('focused');
            if (!this.classList.contains('revealed')) this.classList.add('revealed');
            speakText(word);
        };
        card.innerHTML = `<div class="vocab-top"><div><span class="vocab-word">${word}</span> <span style="font-size:12px;color:#888;">${info.ph}</span></div><button style="border:none;background:none;color:#2979FF;" onclick="event.stopPropagation(); stopAutoPlay(); speakText('${word}')">ğŸ”Š</button></div><div class="vocab-mask">ç‚¹å‡»æŸ¥çœ‹</div><div class="vocab-reveal"><span class="pos-tag">${info.pos}</span> ${info.cn}</div>`;
        return card;
    }

    function renderContent() {
        const container = document.getElementById('col-mid');
        container.innerHTML = "";
        storyData.paragraphs.forEach((para, idx) => {
            let card = document.createElement('div');
            card.className = 'script-card';
            card.id = `para-${idx}`;
            card.onclick = (e) => {
                if(!e.target.classList.contains('highlight-word')) {
                    stopAutoPlay();
                    activateParagraph(idx);
                }
            };
            let htmlText = para.text.replace(/{(\w+)}/g, (match, word) => `<span class="highlight-word" onclick="handleWordClick('${word}', ${idx}, event)">${word}</span>`);
            card.innerHTML = `<div class="en-text">${htmlText}</div><div class="cn-text">${para.cn}</div>`;
            container.appendChild(card);
        });
        
        let divider = document.createElement('div');
        divider.className = 'section-divider';
        divider.innerText = "â€”â€”â€” âœ¨ Quiz Time (äº’åŠ¨æŒ‘æˆ˜) âœ¨ â€”â€”â€”";
        container.appendChild(divider);

        storyData.quizzes.forEach((quiz, qIdx) => {
            let qCard = document.createElement('div');
            qCard.className = 'quiz-card';
            qCard.innerHTML = `<div style="font-weight:bold;color:#EF6C00;margin-bottom:8px;">Question ${qIdx + 1}</div><div style="display:flex; align-items:center; margin-bottom:10px;"><div style="font-weight:bold; flex:1; font-size:16px;">${quiz.question}</div><button class="audio-btn" onclick="handleQuestionClick(${qIdx}, '${quiz.question}')">ğŸ”Š å¬é¢˜</button></div><div class="options-container">${quiz.options.map((opt, oIdx) => `<div class="quiz-opt" onclick="checkAnswer(this, ${oIdx}, ${quiz.answer}, '${opt}')"><span>${opt}</span></div>`).join('')}</div>`;
            container.appendChild(qCard);
        });
        let spacer = document.createElement('div');
        spacer.style.height = "50px";
        container.appendChild(spacer);
    }

    function handleQuestionClick(qIdx, text) {
        stopAutoPlay();
        const allQuizCards = document.querySelectorAll('.quiz-card');
        if(allQuizCards[qIdx]) {
            const options = allQuizCards[qIdx].querySelectorAll('.quiz-opt');
            options.forEach(opt => opt.classList.remove('correct', 'wrong'));
        }
        speakText(text);
    }

    function handleWordClick(word, paraIdx, event) {
        event.stopPropagation();
        stopAutoPlay();
        activateParagraph(paraIdx, true); 
        const vocabCard = document.getElementById(`vocab-card-${word}`);
        if(vocabCard) {
            document.querySelectorAll('.vocab-card').forEach(el => el.classList.remove('focused'));
            if (!vocabCard.classList.contains('revealed')) vocabCard.classList.add('revealed');
            vocabCard.classList.add('focused');
            vocabCard.scrollIntoView({behavior: "smooth", block: "center"});
        }
        speakText(word);
    }

    function activateParagraph(idx, silent = false) {
        document.querySelectorAll('.script-card').forEach(el => el.classList.remove('active'));
        const activeCard = document.getElementById(`para-${idx}`);
        if(activeCard) {
            activeCard.classList.add('active');
            activeCard.scrollIntoView({behavior: "smooth", block: "center"});
        }
        if(storyData.paragraphs[idx] && storyData.paragraphs[idx].img) {
            document.getElementById('scene-img').src = storyData.paragraphs[idx].img;
        }
        updateSidebar(idx);
        if (!silent) {
            let rawText = storyData.paragraphs[idx].text.replace(/{|}/g, "");
            speakText(rawText);
        }
    }

    function updateSidebar(idx) {
        const container = document.getElementById('vocab-container');
        container.innerHTML = "";
        const vocabMap = storyData.paragraphs[idx].vocab;
        const header = document.getElementById('vocab-header-el');
        if(header) { header.innerText = "ğŸ”‘ æ ¸å¿ƒè¯æ±‡ (ç‚¹å‡»å…¨æ˜¾)"; header.style.color = "#333"; }
        for (let [word, info] of Object.entries(vocabMap)) {
            let card = createVocabCard(word, info);
            container.appendChild(card);
        }
    }

    window.checkAnswer = function(el, selIdx, ansIdx, text) {
        stopAutoPlay(); 
        speakText(text);
        if(selIdx === ansIdx) {
            el.classList.add('correct');
            el.classList.remove('wrong');
        } else {
            el.classList.add('wrong');
            el.classList.remove('correct');
        }
    }

    function toggleAutoPlay() {
        if (isAutoPlaying) stopAutoPlay();
        else startAutoPlay();
    }

    function startAutoPlay() {
        isAutoPlaying = true;
        const btn = document.getElementById('play-all-btn');
        btn.innerHTML = "â¹"; 
        btn.classList.add('playing');
        playNextParagraph(0);
    }

    function stopAutoPlay() {
        isAutoPlaying = false;
        window.speechSynthesis.cancel();
        const btn = document.getElementById('play-all-btn');
        btn.innerHTML = "â–¶ å…¨æ–‡";
        btn.classList.remove('playing');
    }

    function playNextParagraph(idx) {
        if (!isAutoPlaying || idx >= storyData.paragraphs.length) {
            stopAutoPlay();
            return;
        }
        activateParagraph(idx); 
        let rawText = storyData.paragraphs[idx].text.replace(/{|}/g, "");
        speakText(rawText, () => {
             if(isAutoPlaying) setTimeout(() => playNextParagraph(idx + 1), 500);
        });
    }

    function setSpeed(rate) {
        currentRate = rate;
        document.querySelectorAll('.speed-btn').forEach(btn => {
            if (parseFloat(btn.innerText) === rate) btn.classList.add('active');
            else btn.classList.remove('active');
        });
    }

    /* ================= â˜… V37 åä¸º/å®‰å“ å…¼å®¹æ ¸å¿ƒ ================= */
    
    function speakText(text, onEndCallback) {
        log("Speak Req: " + text);
        window.speechSynthesis.cancel();
        currentUtterance = new SpeechSynthesisUtterance(text);
        
        // â˜… åä¸ºä¿®å¤ï¼šä¸æŒ‡å®šä»»ä½• voiceï¼Œè®©ç³»ç»Ÿå®Œå…¨æ¥ç®¡
        // åªåœ¨æœ‰æ˜ç¡®çš„ 'en-US' æ—¶æ‰æŒ‡å®šï¼Œå¦åˆ™å°±ä¸æŒ‡å®š
        if (availableVoices.length > 0) {
             let targetVoice = availableVoices.find(v => v.lang === 'en-US');
             if (targetVoice) {
                 currentUtterance.voice = targetVoice;
                 log("Used Voice: " + targetVoice.name);
             } else {
                 log("No US voice. Using System Default.");
             }
        }

        // â˜… åä¸ºä¿®å¤ï¼šä¸è®¾ç½® langï¼Œè®©ç³»ç»Ÿè‡ªå·±çŒœï¼ˆæœ‰äº›ç³»ç»Ÿè®¾ç½®äº† lang åè€Œæ‰¾ä¸åˆ°ï¼‰
        // currentUtterance.lang = 'en-US'; 

        // â˜… åä¸ºä¿®å¤ï¼šä¸è®¾ç½® rateï¼Œæœ‰äº›å¼•æ“å¯¹é 1.0 çš„é€Ÿåº¦ä¼šå´©æºƒ
        // currentUtterance.rate = currentRate; 

        if(onEndCallback) {
            currentUtterance.onend = () => { log("End."); onEndCallback(); };
            currentUtterance.onerror = (e) => { 
                log("Err: " + e.error);
                if (e.error === 'synthesis-failed') {
                    alert("é”™è¯¯ï¼šæ‚¨çš„å¹³æ¿æ²¡æœ‰å®‰è£…è‹±è¯­è¯­éŸ³åŒ…ã€‚\nè¯·å» è®¾ç½® -> æ–‡æœ¬è½¬è¯­éŸ³ -> é¦–é€‰å¼•æ“ -> å®‰è£…è¯­éŸ³æ•°æ®ã€‚");
                }
            };
        }

        window.speechSynthesis.speak(currentUtterance);
    }
</script>
</body>
</html>